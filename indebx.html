<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی دوز آنلاین</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f0f4f8;
            direction: rtl;
        }
        .container {
            direction: rtl;
        }
        .game-board {
            display: grid;
            grid-template-columns: repeat(3, 100px);
            grid-template-rows: repeat(3, 100px);
            gap: 10px;
        }
        .cell {
            width: 100px;
            height: 100px;
            background-color: #e2e8f0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
            cursor: pointer;
            border-radius: 12px;
            transition: background-color 0.2s, transform 0.2s;
            user-select: none;
        }
        .cell:not(.disabled):hover {
            background-color: #cbd5e1;
        }
        .cell.disabled {
            cursor: not-allowed;
        }
        .player-x {
            color: #ef4444;
        }
        .player-o {
            color: #3b82f6;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="loadingScreen" class="absolute inset-0 bg-gray-100 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="loader mx-auto mb-4"></div>
            <p class="text-lg text-gray-700">درحال بارگذاری...</p>
        </div>
    </div>

    <div id="mainApp" class="container bg-white rounded-xl shadow-lg p-6 w-full max-w-lg hidden">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">بازی دوز آنلاین</h1>

        <div id="roomSelection" class="text-center">
            <h2 class="text-xl font-semibold mb-4">انتخاب یا ایجاد اتاق</h2>
            <button id="createRoomButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-transform transform hover:scale-105 active:scale-95 text-lg mb-4">
                ساخت اتاق جدید
            </button>
            <div class="mb-4 text-gray-600">یا به یک اتاق موجود بپیوندید:</div>
            <div id="roomsList" class="flex flex-col space-y-2">
                </div>
        </div>

        <div id="gameScreen" class="hidden">
            <div id="connectionStatus" class="mb-4 text-center text-sm font-semibold text-gray-600"></div>
            <div id="game-board" class="game-board mx-auto">
                </div>
            <div class="flex justify-center items-center mt-6">
                <button id="resetButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-transform transform hover:scale-105 active:scale-95 disabled:bg-gray-400 disabled:cursor-not-allowed text-lg">
                    شروع مجدد
                </button>
            </div>
        </div>

        <div id="messageBox" class="mt-8 bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded relative hidden">
            <span id="messageContent" class="block sm:inline"></span>
            <span class="absolute top-0 bottom-0 left-0 px-4 py-3 cursor-pointer" onclick="document.getElementById('messageBox').classList.add('hidden')">
                <svg class="fill-current h-6 w-6 text-blue-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>بستن</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.03a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15L5.65 6.849a1.2 1.2 0 1 1 1.697-1.697L10 8.181l2.651-3.03a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.15 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
            </span>
        </div>
    </div>

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script>
        const GITHUB_TOKEN = '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';
        const REPO_OWNER = '1393amirgamer-netizen';
        const REPO_NAME = 'a70403631-ops.github.io';
        const ROOMS_FILE_PATH = 'rooms.json';

        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const peerIdFromURL = urlParams.get('peerId');
        const roomIdFromURL = urlParams.get('roomId');

        let peer = null;
        let connection = null;
        let gameActive = true;
        let currentPlayer = 'X';
        let board = Array(9).fill(null);
        let players = { 'X': '', 'O': '' };
        const boardElement = document.getElementById('game-board');
        const statusMessage = document.getElementById('connectionStatus');
        const resetButton = document.getElementById('resetButton');
        const messageBox = document.getElementById('messageBox');
        const messageContent = document.getElementById('messageContent');
        const loadingScreen = document.getElementById('loadingScreen');
        const mainApp = document.getElementById('mainApp');
        const roomsListElement = document.getElementById('roomsList');

        function showMessage(text) {
            messageContent.innerText = text;
            messageBox.classList.remove('hidden');
        }

        function updateStatus(text) {
            statusMessage.innerHTML = text;
        }
        
        const checkWinner = () => {
            const winningCombinations = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8],
                [0, 3, 6], [1, 4, 7], [2, 5, 8],
                [0, 4, 8], [2, 4, 6]
            ];
            for (const combination of winningCombinations) {
                const [a, b, c] = combination;
                if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                    return board[a];
                }
            }
            if (board.every(cell => cell !== null)) {
                return 'Draw';
            }
            return null;
        };

        const renderBoard = () => {
            boardElement.innerHTML = '';
            board.forEach((value, index) => {
                const cell = document.createElement('div');
                cell.classList.add('cell', 'rounded-lg', 'bg-gray-200', 'hover:bg-gray-300', 'transition-colors');
                if (value) {
                    cell.textContent = value;
                    cell.classList.add(`player-${value.toLowerCase()}`);
                    cell.classList.add('disabled');
                }
                cell.addEventListener('click', () => handleCellClick(index));
                boardElement.appendChild(cell);
            });
        };

        const handleCellClick = (index) => {
            if (!gameActive || board[index] !== null) return;
            if (players[currentPlayer] !== peer.id) {
                showMessage("صبر کن! نوبت حریف است.");
                return;
            }

            board[index] = currentPlayer;
            renderBoard();
            const winner = checkWinner();

            if (winner) {
                gameActive = false;
                if (winner === 'Draw') {
                    updateStatus('بازی مساوی شد!');
                    showMessage('بازی مساوی شد!');
                } else {
                    updateStatus(`بازیکن ${winner} برنده شد!`);
                    showMessage(`بازیکن ${winner} برنده شد!`);
                }
            } else {
                currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
                updateStatus(`نوبت بازیکن ${currentPlayer} است.`);
            }
            sendBoardState();
        };

        const sendBoardState = () => {
            if (connection) {
                const data = {
                    board,
                    currentPlayer,
                    gameActive,
                    players
                };
                connection.send(JSON.stringify(data));
            }
        };

        const handleReceivedData = (data) => {
            const gameState = JSON.parse(data);
            board = gameState.board;
            currentPlayer = gameState.currentPlayer;
            gameActive = gameState.gameActive;
            players = gameState.players;
            
            renderBoard();

            if (!gameActive) {
                const winner = checkWinner();
                if (winner === 'Draw') {
                    updateStatus('بازی مساوی شد!');
                    showMessage('بازی مساوی شد!');
                } else {
                    updateStatus(`بازیکن ${winner} برنده شد!`);
                    showMessage(`بازیکن ${winner} برنده شد!`);
                }
            } else {
                updateStatus(`نوبت بازیکن ${currentPlayer} است.`);
            }
        };

        const resetGame = () => {
            gameActive = true;
            board = Array(9).fill(null);
            currentPlayer = 'X';
            updateStatus('نوبت بازیکن X است.');
            renderBoard();
            if (connection) {
                sendBoardState();
            }
        };
        resetButton.addEventListener('click', resetGame);

        const setupPeer = (isHost) => {
            peer = new Peer();
            peer.on('open', (id) => {
                if (isHost) {
                    const roomInfo = { id: roomIdFromURL, peerId: id, status: 'waiting' };
                    updateRooms([roomInfo]).then(() => {
                        updateStatus(`شما بازیکن X هستید. کد اتاق: ${roomIdFromURL}<br>منتظر بازیکن O باشید.`);
                    });
                } else {
                    updateStatus('درحال اتصال به میزبان...');
                    connection = peer.connect(peerIdFromURL);
                    connection.on('open', () => {
                        updateStatus('به بازی متصل شدید. نوبت بازیکن X است.');
                        players['O'] = id;
                        connection.send(JSON.stringify({ players }));
                    });
                    connection.on('data', handleReceivedData);
                    connection.on('close', () => {
                        updateStatus('ارتباط قطع شد.');
                        showMessage('ارتباط با بازیکن دیگر قطع شد. صفحه را رفرش کنید.');
                    });
                }
                showMainApp();
            });

            peer.on('connection', (conn) => {
                if (isHost) {
                    connection = conn;
                    connection.on('open', () => {
                        updateStatus('بازیکن O به بازی پیوست. نوبت بازیکن X است.');
                        players['O'] = connection.peer;
                        sendBoardState();
                    });
                    connection.on('data', handleReceivedData);
                    connection.on('close', () => {
                        updateStatus('ارتباط قطع شد.');
                        showMessage('ارتباط با بازیکن دیگر قطع شد. صفحه را رفرش کنید.');
                    });
                }
            });

            peer.on('error', (err) => {
                console.error(err);
                updateStatus('خطا در اتصال. لطفاً صفحه را دوباره بارگذاری کنید.');
            });
        };

        async function getRooms() {
            try {
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${ROOMS_FILE_PATH}`, {
                    headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
                });
                if (response.status === 404) return [];
                const data = await response.json();
                const content = atob(data.content);
                return JSON.parse(content);
            } catch (error) {
                console.error('Error fetching rooms:', error);
                return [];
            }
        }

        async function updateRooms(newRooms) {
            try {
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${ROOMS_FILE_PATH}`, {
                    headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
                });
                const data = await response.json();
                const sha = data.sha;
                const newContent = btoa(JSON.stringify(newRooms, null, 2));

                await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${ROOMS_FILE_PATH}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'Update rooms list',
                        content: newContent,
                        sha: sha
                    })
                });
            } catch (error) {
                console.error('Error updating rooms:', error);
                showMessage('خطا در به‌روزرسانی لیست اتاق‌ها.');
            }
        }

        async function renderRoomsList() {
            roomsListElement.innerHTML = '<div class="text-center loader mx-auto"></div>';
            
            const rooms = await getRooms();
            roomsListElement.innerHTML = '';
            
            if (rooms.length === 0) {
                roomsListElement.innerHTML = '<p class="text-gray-500">هیچ اتاقی موجود نیست.</p>';
            } else {
                rooms.forEach(room => {
                    const button = document.createElement('button');
                    button.classList.add('bg-gray-200', 'hover:bg-gray-300', 'text-gray-800', 'font-bold', 'py-2', 'px-4', 'rounded-lg', 'transition-colors');
                    button.textContent = `اتاق ${room.id}`;
                    button.onclick = () => {
                        window.location.href = `${window.location.origin}${window.location.pathname}?roomId=${room.id}&peerId=${room.peerId}`;
                    };
                    roomsListElement.appendChild(button);
                });
            }
        }

        document.getElementById('createRoomButton').onclick = async () => {
            const newRoomId = Math.random().toString(36).substring(2, 8);
            window.location.href = `${window.location.origin}${window.location.pathname}?roomId=${newRoomId}`;
        };

        const setupGameScreen = () => {
            document.getElementById('roomSelection').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            renderBoard();
        };

        const showMainApp = () => {
            loadingScreen.classList.add('hidden');
            mainApp.classList.remove('hidden');
        };

        window.onload = () => {
            if (roomIdFromURL) {
                const isHost = !peerIdFromURL;
                setupPeer(isHost);
                setupGameScreen();
            } else {
                renderRoomsList();
                showMainApp();
            }
        };
    </script>
</body>
</html>


